version: v1.0

name: Docker‑Compose CI

agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004

# Attach the two file‑type secrets to every job,
# and run the prologue before any job commands.
global_job_config:
  # secrets:
  #   - name: root‑env‑file
  #   - name: website‑env‑file

  prologue:
    commands:
      # checkout must come first
      # - checkout
      # copy the root .env into your workspace
      # - cp /home/semaphore/root‑env‑file/.env ./.env
      # ensure website/ exists & copy its .env
      # - mkdir -p website
      # - cp /home/semaphore/website‑env‑file/.env website/.env
      - ls  

blocks:
  - name: Run tests in Docker Compose
    task:
      jobs:
        - name: up & test
          commands:
            # bring up all services, abort on first container exit,
            # and return the exit code of the `test` service
            - docker-compose up --abort-on-container-exit --exit-code-from test
