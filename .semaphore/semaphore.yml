version: v1.0

name: Docker‑Compose CI

agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004

# Attach the two file‑type secrets to every job,
# and run the prologue before any job commands.
global_job_config:
  secrets:
    - name: ENV_FILE

  prologue:
    commands:
      - checkout
      - ls
      # copy the root .env from the secret into your workspace
      - cp /home/semaphore/ENV_FILE/.env ./.env
      # copy the website/.env into website/
      - mkdir -p website
      - cp /home/semaphore/ENV_FILE/website/.env website/.env

blocks:
  - name: Run tests in Docker Compose
    task:
      jobs:
        - name: up & test
          commands:
            # bring up all services, abort on first container exit,
            # and return the exit code of the `test` service
            - docker-compose up --abort-on-container-exit --exit-code-from test
